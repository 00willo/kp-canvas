#!/usr/bin/perl

use strict;

use lib './lib';
use feature ':5.10';

use Data::Dumper;

use Canvas::Store::WPUser;
use Canvas::Store::User;

sub migrate_wp_user {
  my $u = shift;

  return unless defined $u;

  my $wp = Canvas::Store::WPUser->search({ user_login => $u->username })->first;

  return unless defined $wp;

  say 'Found WP user ' . $u->username . '! Migrating ...';

  $u->password( $wp->user_pass );
  $u->email( $wp->user_email );
  $u->update;
}

# create firnsy
if( 0 ) {
  my $firnsy = Canvas::Store::User->find_or_create({
    username => 'firnsy',
    status   => 'active',
    access   => 255,
  });

# create csmart
  my $csmart = Canvas::Store::User->find_or_create({
    username => 'csmart',
    status   => 'active',
    access   => 255,
  });

  my $test = Canvas::Store::User->find_or_create({
    username => 'test_subscriber',
    status   => 'active',
  });

  my $woot = Canvas::Store::User->find_or_create({
    username => 'Anonymous',
    status   => 'active',
  });


  $test->add_to_user_memberships({
    member_id => $firnsy->id,
    access    => 128,
  });

  $test->add_to_user_memberships({
    member_id => $csmart->id,
    access    => 128,
  });


  migrate_wp_user( $firnsy );
  migrate_wp_user( $csmart );
};
